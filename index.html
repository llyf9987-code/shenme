<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy Birthday Xiao Ye! | Usagi Wishes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Zeyada&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              usagi: {
                main: '#F9D59B', orange: '#FBBF77', gold: '#F8C860',
                pink: '#F8C8DC', text: '#5D4037', light: '#FFFBE6', hover: '#F7C070',
                cream: '#FFF9E6'
              }
            },
            fontFamily: {
              sans: ['Fredoka', 'sans-serif'],
              hand: ['Zeyada', 'cursive'],
              cute: ['"ZCOOL KuaiLe"', 'cursive'],
            },
            animation: {
              'float': 'float 3s ease-in-out infinite',
              'bounce-slow': 'bounce 2s infinite',
              'drift': 'drift 10s linear infinite',
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
              drift: { '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '0' }, '50%': { opacity: '0.5' }, '100%': { transform: 'translateY(100px) rotate(180deg)', opacity: '0' } }
            },
            boxShadow: {
              'soft': '0 8px 32px rgba(93, 64, 55, 0.15)',
              'glow': '0 0 15px rgba(240, 98, 146, 0.5)',
            }
          }
        }
      }
    </script>
    <style>
      /* Apply cursor to html and body with specific hotspot coordinates (0 0) */
      html, body { 
        background-color: #F9D59B; 
        overflow-x: hidden; 
        cursor: url('./images/usagi-cursor.png') 0 0, auto !important;
      }
      
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .mirror-x { transform: scaleX(-1); }
      
      /* Refined Glassmorphism */
      .glass-card {
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }

      /* Text Shadow Utilities for Title */
      .title-glow {
        text-shadow: 2px 2px 0px #FFF, 0 0 10px #F06292;
      }
      
      /* Button Text Stroke Simulation */
      .btn-text-stroke {
        text-shadow: 1px 1px 0px rgba(160, 80, 0, 0.3);
      }
    </style>
    
    <!-- Import Maps: Fixed to prevent version conflicts -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0,react-dom@18.2.0",
        "three": "https://esm.sh/three@0.160.0",
        "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
        "gsap": "https://esm.sh/gsap@3.12.5",
        "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { motion, AnimatePresence } from 'framer-motion';
      import { Volume2, VolumeX, ArrowLeft, X, ArrowRight, Camera, Mic, Flame, Wind, Hand, RefreshCw, XCircle, Heart, Sparkles, Download, Share2, PenTool, AlertCircle, User, Lock, Eye, EyeOff, MessageCircle, Bell, ChevronLeft } from 'lucide-react';
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import gsap from 'gsap';
      import confetti from 'canvas-confetti';
      import html2canvas from 'html2canvas';

      // --- 1. CONSTANTS & ASSETS ---
      const RECIPIENT_NAME = "Â∞èÂè∂";
      const SENDER_NAME = "Best Friend";
      
      const ASSETS = {
        balloons: [
          './images/balloon1.png',
          './images/balloon2.png',
          './images/balloon3.png'
        ],
        giftImage: './images/usagi-surprise.png',
        // Updated to external URL as requested
        loginBackground: 'https://xland.eu.org/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251211/js6e/1922X1074/background.jpg', 
        sounds: {
          bgm: 'https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg',
        }
      };

      const BIRTHDAY_LETTER = `Á•ù‰Ω†ÁîüÊó•Âø´‰πêÔºÅ
      ÊÑø‰Ω†ÂÉè‰πåËê®Â•á‰∏ÄÊ†∑Êó†ÂøßÊó†ËôëÔºå
      Ë¢´Ê∏©ÊöñÂåÖÂõ¥Ôºå
      Êö¥ÂØå„ÄÅÂºÄÂøÉ„ÄÅÂÅ•Â∫∑ÔºÅ
      ÊâÄÊúâÁæéÂ•ΩÂ¶ÇÊúüËÄåËá≥~`;

      const GIFT_SURPRISES = {
        messages: ["üå∏ Ê°ÉËä±ÊúµÊúµÂºÄ!", "‚ú® ‰ªäÂ§©‰Ω†ÂèëÂÖâ!", "ü•ï Èõ∂È£üÂêÉ‰∏çËÉñ!", "üí∞ Êö¥ÂØåÂú®Ë∑Ø‰∏ä!", "üí§ Â§©Â§©Áù°Â•ΩËßâ!"]
      };

      const PHOTOS = [
        { id: 1, url: 'https://picsum.photos/800/800?random=11', rotation: -3 },
        { id: 2, url: 'https://picsum.photos/800/800?random=12', rotation: 2 },
        { id: 3, url: 'https://picsum.photos/800/800?random=13', rotation: -1 },
        { id: 4, url: 'https://picsum.photos/800/800?random=14', rotation: 4 },
        { id: 5, url: 'https://picsum.photos/800/800?random=15', rotation: -2 },
        { id: 6, url: 'https://picsum.photos/800/800?random=16', rotation: 3 },
        { id: 7, url: 'https://picsum.photos/800/800?random=17', rotation: -4 },
        { id: 8, url: 'https://picsum.photos/800/800?random=18', rotation: 1 },
        { id: 9, url: 'https://picsum.photos/800/800?random=19', rotation: -2 }
      ];

      // --- 2. COMPONENTS ---

      // SCENE 0: LOGIN
      const Scene0Login = ({ onLogin }) => {
        const [showPassword, setShowPassword] = useState(false);
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [shake, setShake] = useState(false);

        const handleLogin = (e) => {
          e.preventDefault();
          // Validation Logic
          if (username === 'xiaoma' && password === '1227') {
            setError('');
            onLogin();
          } else {
            setError('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï');
            setShake(true);
            setTimeout(() => setShake(false), 500); // Reset shake animation
          }
        };

        return (
          <motion.div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center overflow-hidden"
            style={{ backgroundImage: `url(${ASSETS.loginBackground})` }}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0, scale: 1.1 }}
            transition={{ duration: 0.8 }}
          >
            {/* Dark overlay for better text readability */}
            <div className="absolute inset-0 bg-black/20 backdrop-blur-[1px]"></div>

            <motion.div 
              className="glass-card w-[90%] max-w-[400px] rounded-2xl p-8 relative z-10 flex flex-col items-center"
              initial={{ y: 50, opacity: 0 }}
              animate={shake ? { x: [-10, 10, -10, 10, 0] } : { y: 0, opacity: 1 }}
              transition={shake ? { duration: 0.4 } : { delay: 0.2, type: "spring", stiffness: 50 }}
            >
              <h2 className="text-3xl font-bold text-white mb-2 tracking-wide drop-shadow-md">Ê¨¢ËøéÂõûÊù•</h2>
              <p className="text-white/80 text-sm mb-6">ËØ∑ÁôªÂΩïÊÇ®ÁöÑË¥¶Êà∑</p>

              <form onSubmit={handleLogin} className="w-full space-y-4">
                {/* Username */}
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <User size={20} />
                  </div>
                  <input 
                    type="text" 
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="Â∞è‰∏ªÔºåËØ∑Ëµê‰∏™Áî®Êà∑Âêç" 
                    className="w-full py-3.5 pl-12 pr-4 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                </div>

                {/* Password */}
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <Lock size={20} />
                  </div>
                  <input 
                    type={showPassword ? "text" : "password"} 
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Â∞è‰∏ªÁöÑÈÄöÂÖ≥ÂØÜ‰ª§" 
                    className="w-full py-3.5 pl-12 pr-12 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                  >
                    {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                  </button>
                </div>

                {/* Error Message */}
                {error && (
                  <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} className="text-red-200 bg-red-500/30 px-3 py-1 rounded-2xl text-xs text-center font-bold">
                    {error}
                  </motion.div>
                )}

                {/* Extras */}
                <div className="flex justify-between items-center text-xs text-white/90 px-1">
                  <label className="flex items-center gap-2 cursor-pointer hover:text-white transition-colors">
                    <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-usagi-orange focus:ring-usagi-orange" />
                    <span>ËÆ∞‰ΩèÊàë</span>
                  </label>
                  <button type="button" className="hover:underline hover:text-white transition-colors">ÂøòËÆ∞ÂØÜÁ†Å?</button>
                </div>

                {/* Login Button */}
                <button 
                  type="submit"
                  className="w-full py-3.5 rounded-2xl bg-gradient-to-r from-[#8A7CFB] to-[#635BFF] text-white font-bold text-lg shadow-lg hover:shadow-xl hover:opacity-90 active:scale-[0.98] transition-all mt-4"
                >
                  Â∞è‰∏ªËØ∑Ëøõ
                </button>
              </form>

              {/* Divider */}
              <div className="w-full flex items-center gap-4 my-6 text-white/60 text-xs">
                <div className="h-px bg-white/30 flex-1"></div>
                <span>ÊàñËÄÖ</span>
                <div className="h-px bg-white/30 flex-1"></div>
              </div>

              {/* Social Login */}
              <div className="w-full space-y-3">
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#07C160] font-bold border border-[#07C160]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <MessageCircle size={20} fill="currentColor" className="text-[#07C160]" />
                  <span>‰ΩøÁî®ÂæÆ‰ø°ÁôªÂΩï</span>
                </button>
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#0099FF] font-bold border border-[#0099FF]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <Bell size={20} fill="currentColor" className="text-[#0099FF]" />
                  <span>‰ΩøÁî®QQÁôªÂΩï</span>
                </button>
              </div>

              {/* Footer */}
              <div className="mt-8 text-xs text-white/80">
                ËøòÊ≤°ÊúâË¥¶Êà∑? <button className="text-blue-200 font-bold hover:underline ml-1">Á´ãÂç≥Ê≥®ÂÜå</button>
              </div>

            </motion.div>
          </motion.div>
        );
      };

      // Usagi Character Component (Updated with Custom Image)
      const UsagiCharacter = ({ action, className, onClick, boardText }) => {
        const variants = {
          idle: { y: [0, -5, 0], transition: { repeat: Infinity, duration: 2 } },
          jump: { y: [0, -50, 0], scale: [1, 1.1, 0.9, 1], transition: { repeat: Infinity, duration: 0.6 } },
          wave: { rotate: [0, 10, -10, 0], transition: { repeat: Infinity, duration: 1 } },
          camera: { scale: [1, 1.05, 1], transition: { duration: 0.3 } },
          cheer: { y: [0, -20, 0], transition: { repeat: Infinity, duration: 0.4 } },
          shhh: { scale: 1 },
          'hold-board': { y: [0, -3, 0], transition: { repeat: Infinity, duration: 3 } },
          heart: { scale: [1, 1.1, 1], transition: { duration: 0.5, repeat: Infinity, repeatDelay: 1 } }
        };

        return (
          <motion.div 
            className={`relative cursor-pointer select-none ${className}`}
            onClick={onClick}
            animate={action}
            variants={variants}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            {/* Replaced SVG with Custom Image */}
            <img 
              src="./images/mai.png" 
              alt="Character" 
              className="w-full h-full object-contain drop-shadow-lg pointer-events-none"
              draggable="false"
            />
            
            {/* Accessories / Overlays based on action */}
            {action === 'heart' && (
                <motion.div 
                  className="absolute -top-4 -right-4 text-4xl filter drop-shadow-md"
                  initial={{ scale: 0, opacity: 0 }}
                  animate={{ scale: [1, 1.2, 1], opacity: 1 }}
                  transition={{ duration: 0.8, repeat: Infinity }}
                >
                  ‚ù§Ô∏è
                </motion.div>
            )}

            {action === 'camera' && (
                <motion.div 
                  className="absolute bottom-0 right-0 text-3xl filter drop-shadow-md"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                >
                  üì∑
                </motion.div>
            )}
            
            {/* Hold Board Overlay */}
            {action === 'hold-board' && (
               <div className="absolute top-[55%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-[110%] h-[40%] max-w-[300px]">
                  <div className="w-full h-full bg-white border-4 border-dashed border-usagi-orange rounded-xl flex items-center justify-center p-3 shadow-lg transform -rotate-2 relative z-10">
                      <div className="text-sm md:text-xl text-center font-hand text-usagi-text leading-tight break-words w-full h-full flex items-center justify-center">
                          {boardText || "Happy Birthday!"}
                      </div>
                  </div>
               </div>
            )}
          </motion.div>
        );
      };

      // Background Component
      const Background = () => {
        const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });
        useEffect(() => {
          const handleMouseMove = (e) => setMousePosition({ x: e.clientX, y: e.clientY });
          window.addEventListener('mousemove', handleMouseMove);
          return () => window.removeEventListener('mousemove', handleMouseMove);
        }, []);
        return (
          <div className="fixed inset-0 z-0 overflow-hidden bg-gradient-to-b from-[#FFF9E6] to-[#F9D59B] pointer-events-none">
            <motion.div initial={{ x: -100 }} animate={{ x: '100vw' }} transition={{ duration: 35, repeat: Infinity, ease: 'linear' }} className="absolute top-10 left-0 text-white opacity-60 text-9xl blur-sm">‚òÅÔ∏è</motion.div>
            {Array.from({ length: 20 }).map((_, i) => (
              <motion.div key={i} className="absolute rounded-full bg-[#FBBF77] shadow-[0_0_10px_#FBBF77]"
                style={{ width: Math.random() * 8 + 4, height: Math.random() * 8 + 4, top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, x: (mousePosition.x * 0.02 * (i % 2 === 0 ? 1 : -1)), y: (mousePosition.y * 0.02 * (i % 2 === 0 ? 1 : -1)) }}
                animate={{ opacity: [0.4, 1, 0.4], scale: [1, 1.2, 1] }} transition={{ duration: 1, repeat: Infinity, delay: Math.random() * 2 }}
              />
            ))}
          </div>
        );
      };

      // Atmospheric Particles Component (New)
      const AtmosphereParticles = () => {
        const particles = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
          id: i,
          x: Math.random() * 100,
          y: Math.random() * 100,
          size: Math.random() * 10 + 5,
          color: ['#FFCdd2', '#FFF9C4', '#B2DFDB'][Math.floor(Math.random() * 3)],
          duration: Math.random() * 10 + 10,
          delay: Math.random() * 5
        })), []);

        return (
          <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
            {particles.map((p) => (
              <motion.div
                key={p.id}
                className="absolute rounded-full opacity-30"
                style={{
                  left: `${p.x}%`,
                  top: -20,
                  width: p.size,
                  height: p.size,
                  backgroundColor: p.color,
                  boxShadow: `0 0 10px ${p.color}`
                }}
                animate={{
                  y: ['0vh', '100vh'],
                  x: [0, Math.random() * 50 - 25],
                  rotate: [0, 360]
                }}
                transition={{
                  duration: p.duration,
                  repeat: Infinity,
                  ease: "linear",
                  delay: p.delay
                }}
              />
            ))}
          </div>
        );
      };

      // Back Button Component (Updated)
      const BackButton = ({ onClick, disabled = false }) => (
        <motion.button 
          onClick={onClick} 
          disabled={disabled} 
          initial={{ opacity: 0 }} 
          animate={{ opacity: disabled ? 0.5 : 1 }} 
          whileHover={!disabled ? { scale: 1.1 } : {}} 
          whileTap={!disabled ? { scale: 0.95 } : {}}
          className={`fixed bottom-6 right-6 z-50 flex items-center justify-center w-16 h-16 rounded-full shadow-lg border-4 border-white transition-all duration-300 overflow-hidden ${disabled ? 'bg-usagi-main/50 cursor-not-allowed grayscale' : 'bg-[#F9D59B] hover:bg-[#F7C070] cursor-pointer'}`}
        >
          <div className="w-10 h-10 mt-1">
             <UsagiCharacter action="idle" className="w-full h-full" />
          </div>
        </motion.button>
      );

      // --- 3. SCENES ---

      // SCENE 1: Intro
      const Scene1Intro = ({ onStart }) => {
        const balloons = useMemo(() => {
          return Array.from({ length: 15 }).map((_, i) => {
            const scale = Math.random() * 0.4 + 0.8;
            const speed = Math.random() * 10 + 15;
            const sway = Math.random() * 50 + 30;
            const swayTime = Math.random() * 3 + 4;
            
            return {
              id: i,
              src: ASSETS.balloons[i % ASSETS.balloons.length],
              left: Math.random() * 90 + 5,
              scale: scale,
              duration: speed,
              delay: Math.random() * 12,
              swayAmount: sway,
              swayDuration: swayTime,
              rotateAmount: Math.random() * 10 + 5
            };
          });
        }, []);

        return (
          <motion.div className="relative w-full h-screen flex flex-col items-center justify-center z-10 overflow-hidden" exit={{ opacity: 0, x: -50 }}>
            {balloons.map((b) => (
              <motion.img 
                key={b.id} 
                src={b.src} 
                className="absolute -bottom-40 w-[100px] object-contain opacity-90" 
                style={{ left: `${b.left}%`, scale: b.scale }}
                initial={{ y: 0 }}
                animate={{ 
                  y: -window.innerHeight - 300,
                  x: [0, b.swayAmount, 0, -b.swayAmount, 0],
                  rotate: [0, b.rotateAmount, 0, -b.rotateAmount, 0]
                }} 
                transition={{ 
                  y: { duration: b.duration, ease: "linear", repeat: Infinity, delay: b.delay }, 
                  x: { duration: b.swayDuration, ease: "easeInOut", repeat: Infinity },
                  rotate: { duration: b.swayDuration - 1, ease: "easeInOut", repeat: Infinity }
                }} 
              />
            ))}
            <motion.div initial={{ x: -window.innerWidth, y: 100 }} animate={{ x: 0, y: 0 }} transition={{ type: "spring", stiffness: 60, damping: 15 }} className="mb-8 relative z-20 cursor-pointer" whileHover={{ scale: 1.05 }} onClick={onStart}>
              <motion.div className="absolute inset-0 bg-usagi-main/30 rounded-full blur-xl" animate={{ scale: [1, 1.2, 1], opacity: [0.5, 0.8, 0.5] }} transition={{ duration: 2, repeat: Infinity }} />
              <UsagiCharacter action="jump" className="w-56 h-56 md:w-72 md:h-72 relative z-10" />
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.8 }} whileHover={{ scale: 1.05, y: -2 }} whileTap={{ scale: 0.95 }} onClick={onStart}
              className="group relative z-20 bg-usagi-main text-usagi-text font-bold py-3 px-12 rounded-full shadow-lg border-4 border-white hover:border-usagi-orange transition-all overflow-hidden">
              <span className="relative z-10 text-xl font-hand">ÂºÄÂêØÁ•ùÁ¶è ‚ú®</span>
            </motion.button>
          </motion.div>
        );
      };

      // SCENE 2: Photo Wall
      const Scene2PhotoWall = ({ isActive, onNext, showButton, isBackgroundMode }) => {
        const [photosGathered, setPhotosGathered] = useState(false);
        const [usagiAction, setUsagiAction] = useState('camera');
        useEffect(() => {
          if (isActive && !isBackgroundMode && !photosGathered) {
            const timer = setTimeout(() => {
              setPhotosGathered(true);
              setUsagiAction('heart');
              confetti({ particleCount: 150, spread: 120, origin: { y: 0.6 }, colors: ['#F9D59B', '#F8C8DC', '#FBBF77', '#FFFFFF'] });
            }, PHOTOS.length * 1500 + 1000);
            return () => clearTimeout(timer);
          }
          if (isActive && !isBackgroundMode && photosGathered) setUsagiAction('heart');
        }, [isActive, isBackgroundMode, photosGathered]);

        return (
          <div className={`w-full h-full flex flex-col items-center justify-center p-4 transition-all duration-1000 ${isBackgroundMode ? 'brightness-50 opacity-40 grayscale-[0.2]' : ''}`}>
            {!isBackgroundMode && isActive && (
              <motion.h2 initial={{ y: -50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="text-3xl md:text-5xl font-hand text-usagi-text mb-6 z-10 drop-shadow-sm text-center">Our Beautiful Moments</motion.h2>
            )}
            <motion.div className="relative bg-white/60 backdrop-blur-sm border-[6px] border-[#FFF5E1] shadow-2xl grid grid-cols-3 gap-[3px]" style={{ width: '85%', height: '70%' }} initial={{ scale: 0.95 }} animate={photosGathered ? { scale: 1.05 } : { scale: 1 }}>
              {PHOTOS.map((photo, index) => (
                <motion.div key={photo.id} className="relative bg-white overflow-hidden border border-usagi-light w-full h-full"
                  initial={{ opacity: 0, x: index % 2 === 0 ? -600 : 600, y: index < 4 ? -400 : 400, rotate: (Math.random() - 0.5) * 10 }}
                  animate={{ opacity: 1, x: 0, y: 0, rotate: photosGathered ? 0 : photo.rotation }}
                  transition={{ delay: index * 1.5, duration: 2, type: "spring", stiffness: 40 }}>
                  <img src={photo.url} alt="Memory" className="w-full h-full object-cover" />
                </motion.div>
              ))}
            </motion.div>
            <motion.div className="fixed bottom-10 right-4 md:right-10 z-10 pointer-events-none" animate={isBackgroundMode ? { x: 300, opacity: 0 } : { x: 0, opacity: 1 }}>
              <UsagiCharacter action={usagiAction} className="w-32 h-32 md:w-48 md:h-48" />
            </motion.div>
            {showButton && photosGathered && !isBackgroundMode && (
              <motion.button initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} whileHover={{ scale: 1.05, backgroundColor: "#FBBF77" }} onClick={onNext}
                className="mt-8 z-20 bg-usagi-main text-usagi-text px-10 py-3 rounded-full font-bold shadow-lg border-2 border-white transition-colors flex items-center gap-2">
                <span>Êü•Áúã‰∏ìÂ±ûÁ•ùÁ¶è</span><span className="text-xl">üíå</span>
              </motion.button>
            )}
          </div>
        );
      };

      // SCENE 3: Wishes - REFINED & DETAILED
      const Scene3Wishes = ({ onGoToCakeInteraction, onGoToOutro }) => {
        const [giftOpen, setGiftOpen] = useState(false);
        const letterChars = BIRTHDAY_LETTER.split('');

        // Staggered animation for characters
        const containerVariants = {
          hidden: { opacity: 0 },
          visible: {
            opacity: 1,
            transition: { staggerChildren: 0.05, delayChildren: 0.3 }
          }
        };

        const charVariants = {
          hidden: { opacity: 0, y: 5 },
          visible: { opacity: 1, y: 0, transition: { duration: 0.4 } }
        };

        return (
          <div className="relative min-h-screen w-full flex items-center justify-center p-4 md:p-8 overflow-y-auto">
            {/* Atmospheric Decoration */}
            <AtmosphereParticles />

            <div className="relative z-20 w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
              
              {/* Left Side: Upgraded Text Area */}
              <motion.div 
                initial={{ x: -30, opacity: 0 }} 
                animate={{ x: 0, opacity: 1 }} 
                transition={{ duration: 0.8, ease: "easeOut" }}
                className="w-full bg-gradient-to-b from-[#FFF9E6]/80 to-[#FFF9E6]/40 backdrop-blur-[5px] border border-white/40 shadow-soft p-8 md:p-12 rounded-2xl relative flex flex-col justify-between min-h-[420px]"
              >
                {/* Header with Glowing Title */}
                <div className="flex items-center gap-3 mb-8">
                  <motion.h2 
                    className="text-[28px] md:text-3xl font-cute font-bold text-[#F06292] tracking-wide title-glow"
                    animate={{ y: [0, -3, 0] }}
                    transition={{ duration: 2, repeat: Infinity, ease: "easeInOut" }}
                  >
                    Á•ù{RECIPIENT_NAME}ÁîüÊó•Âø´‰πêÔºÅ
                  </motion.h2>
                  <motion.div 
                    className="w-12 h-12 -mt-2"
                    animate={{ rotate: [0, 10, -10, 0] }}
                    transition={{ duration: 2, repeat: Infinity }}
                  >
                    <UsagiCharacter action="cheer" className="w-full h-full" />
                  </motion.div>
                </div>

                {/* Cute Handwritten Body Text (Character Fade In) */}
                <motion.div 
                  className="font-cute text-xl md:text-2xl text-[#5D4037] leading-[1.8] tracking-wide flex-grow"
                  variants={containerVariants}
                  initial="hidden"
                  animate="visible"
                >
                  {letterChars.map((char, i) => (
                    <motion.span key={i} variants={charVariants}>
                      {char}
                    </motion.span>
                  ))}
                </motion.div>

                {/* Signature */}
                <div className="mt-8 flex justify-end">
                  <span className="text-sm font-sans text-gray-500/80 tracking-widest uppercase">
                    Êù•Ëá™ {SENDER_NAME}
                  </span>
                </div>
              </motion.div>

              {/* Right Side: Refined Interaction Stack */}
              <div className="flex flex-col items-center gap-8 relative">
                
                {/* 1. Cake (Top) with Float Hover */}
                <motion.div 
                  className="relative cursor-pointer group" 
                  onClick={onGoToCakeInteraction} 
                  whileHover={{ y: -5, filter: "drop-shadow(0 10px 10px rgba(0,0,0,0.1))" }}
                  whileTap={{ scale: 0.95 }}
                  transition={{ type: "spring", stiffness: 300 }}
                >
                  <div className="text-[8rem] md:text-[9rem] leading-none transition-transform group-hover:rotate-3">üéÇ</div>
                  <span className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-white/90 px-4 py-1.5 rounded-full text-xs font-bold text-usagi-text opacity-0 group-hover:opacity-100 transition-opacity shadow-sm whitespace-nowrap border border-usagi-orange/20">
                    ÁÇπÁáÉËú°ÁÉõ üïØÔ∏è
                  </span>
                </motion.div>

                {/* 2. Gift (Middle) with Float Hover */}
                <motion.div 
                  className="relative cursor-pointer" 
                  onClick={() => setGiftOpen(true)} 
                  whileHover={{ y: -5, rotate: [0, -5, 5, 0], filter: "drop-shadow(0 10px 10px rgba(0,0,0,0.1))" }}
                  whileTap={{ scale: 0.95 }}
                >
                  <div className="text-7xl md:text-8xl filter brightness-105">üéÅ</div>
                </motion.div>

                {/* 3. Button (Bottom) with Ripple & Gradient */}
                <motion.button 
                  onClick={onGoToOutro} 
                  whileHover={{ scale: 1.05, boxShadow: "0 10px 20px rgba(251, 191, 119, 0.4)" }}
                  whileTap={{ scale: 0.95 }}
                  className="mt-4 bg-gradient-to-r from-[#FFB74D] to-[#FF8A65] text-white font-bold text-lg py-4 px-12 rounded-2xl shadow-soft border border-white/30 transition-all flex items-center gap-2 btn-text-stroke relative overflow-hidden group"
                >
                  <span className="relative z-10">ËÆ∏‰∏™ÊÑøÊúõ</span>
                  <ArrowRight size={20} className="relative z-10" />
                  {/* Ripple overlay */}
                  <div className="absolute inset-0 bg-white/20 scale-0 group-active:scale-150 transition-transform duration-300 rounded-full origin-center"></div>
                </motion.button>

              </div>
            </div>

            {/* Gift Popup Overlay */}
            <AnimatePresence>
              {giftOpen && (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
                  <motion.div initial={{ scale: 0.5, y: 100 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.5, opacity: 0 }} className="relative bg-gradient-to-br from-usagi-light to-usagi-main p-1 rounded-2xl shadow-2xl max-w-sm w-full">
                    <div className="bg-white rounded-2xl p-6 text-center border-4 border-dashed border-usagi-orange relative overflow-hidden">
                      <button onClick={() => setGiftOpen(false)} className="absolute top-2 right-2 p-2 text-usagi-text hover:bg-usagi-pink/20 rounded-full transition-colors"><X size={28} /></button>
                      <img src={ASSETS.giftImage} alt="Surprise" className="w-full h-48 object-contain mb-4 rounded-lg bg-usagi-light/50" />
                      <h3 className="text-2xl font-cute font-bold text-usagi-orange mb-2">ÊÉäÂñú!</h3>
                      <p className="text-lg text-usagi-text font-sans font-medium">{GIFT_SURPRISES.messages[Math.floor(Math.random() * GIFT_SURPRISES.messages.length)]}</p>
                    </div>
                  </motion.div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      };

      // SCENE 4: Cake Interaction
      const Scene4CakeInteraction = () => {
        const containerRef = useRef(null);
        const videoRef = useRef(null);
        const rendererRef = useRef(null);
        const particlesRef = useRef(null);
        const cameraRef = useRef(null);
        const controlsRef = useRef(null);
        const handsRef = useRef(null);
        const streamRef = useRef(null);
        const cameraActive = useRef(false);
        const analyserRef = useRef(null);
        const lastActionTime = useRef(0);
        const blowTriggerCount = useRef(0);
        const audioCheckRaf = useRef(0);

        const [cakeState, setCakeState] = useState('SCATTERED');
        const [cameraAuthorized, setCameraAuthorized] = useState(false);
        const [cameraError, setCameraError] = useState(null);
        const [micActive, setMicActive] = useState(false);
        const [feedback, setFeedback] = useState(null);
        const [detectedGesture, setDetectedGesture] = useState('Searching...');
        const [handVisible, setHandVisible] = useState(false);
        const [surpriseActive, setSurpriseActive] = useState(false);

        const stateRef = useRef({ cakeState, surpriseActive });
        useEffect(() => { stateRef.current = { cakeState, surpriseActive }; }, [cakeState, surpriseActive]);

        const stopCamera = useCallback(() => {
             cameraActive.current = false;
             if (streamRef.current) {
                streamRef.current.getTracks().forEach(track => {
                    try { track.stop(); } catch(e) {}
                });
                streamRef.current = null;
             }
             if (videoRef.current) {
                videoRef.current.srcObject = null;
             }
             if (handsRef.current) {
                try { handsRef.current.close(); } catch(e) {}
                handsRef.current = null;
             }
        }, []);

        const CONFIG = useMemo(() => ({
          particleCount: 35000,
          colors: { base: new THREE.Color('#F9D59B'), cream: new THREE.Color('#FFF8E1'), candle: new THREE.Color('#E0C097'), wick: new THREE.Color('#5D4037'), flameCore: new THREE.Color('#FFFFFF'), flameOuter: new THREE.Color('#FBBF77'), heart: new THREE.Color('#FF69B4'), heartGlow: new THREE.Color('#FFC0CB') },
          thresholds: { pinchDist: 0.05, audioLevel: 15 }
        }), []);

        useEffect(() => {
          if (!containerRef.current) return;
          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
          camera.position.set(0, 0, 14); camera.lookAt(0, 0, 0); cameraRef.current = camera;
          const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          containerRef.current.appendChild(renderer.domElement);
          rendererRef.current = renderer;
          const controls = new OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true; controls.dampingFactor = 0.05; controls.autoRotate = true; controls.autoRotateSpeed = 2.0; controls.enableZoom = false; controls.enablePan = false;
          controlsRef.current = controls;

          const positions = new Float32Array(CONFIG.particleCount * 3);
          const targets = new Float32Array(CONFIG.particleCount * 3);
          const heartTargets = new Float32Array(CONFIG.particleCount * 3);
          const colors = new Float32Array(CONFIG.particleCount * 3);
          const sizes = new Float32Array(CONFIG.particleCount);
          const types = new Float32Array(CONFIG.particleCount);
          const CAKE_SCALE = 1.5;

          for (let i = 0; i < CONFIG.particleCount; i++) {
            const i3 = i * 3;
            const r = 25 * Math.cbrt(Math.random()); const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
            positions[i3] = r * Math.sin(phi) * Math.cos(theta); positions[i3 + 1] = r * Math.sin(phi) * Math.sin(theta); positions[i3 + 2] = r * Math.cos(phi);
            
            const rand = Math.random(); let color = new THREE.Color(); let type = 0; let size = Math.random() * 0.5 + 0.8; let tx = 0, ty = 0, tz = 0; const yOffset = -0.5;
            if (rand < 0.65) {
              const noise = (Math.random() - 0.5) * 0.1;
              if (Math.random() > 0.4) { const rad = Math.sqrt(Math.random()) * 3.5; const ang = Math.random() * Math.PI * 2; const h = (Math.random() - 0.5) * 1.5; tx = Math.cos(ang) * rad; ty = h - 1.0; tz = Math.sin(ang) * rad; size = 1.5; }
              else { const rad = Math.sqrt(Math.random()) * 2.2; const ang = Math.random() * Math.PI * 2; const h = (Math.random() - 0.5) * 1.2; tx = Math.cos(ang) * rad; ty = h + 0.5; tz = Math.sin(ang) * rad; size = 1.4; }
              color = CONFIG.colors.base.clone().offsetHSL(0, 0, noise);
            } else if (rand < 0.88) {
              const rad = Math.sqrt(Math.random()) * 2.3; const ang = Math.random() * Math.PI * 2; let h = 0.5; if (Math.random() > 0.7) h -= Math.random() * 0.6; tx = Math.cos(ang) * rad; ty = h + 1.1; tz = Math.sin(ang) * rad; color = CONFIG.colors.cream; size = 1.6;
            } else if (rand < 0.97) {
              const rad = Math.random() * 0.15; const ang = Math.random() * Math.PI * 2; const h = Math.random() * 1.5; tx = Math.cos(ang) * rad; ty = h + 1.8; tz = Math.sin(ang) * rad; color = CONFIG.colors.candle; size = 1.2;
            } else {
              if (Math.random() > 0.3) { tx = 0; ty = 3.4 + Math.random() * 0.1; tz = 0; color = CONFIG.colors.wick; type = 1; }
              else { const rad = Math.random() * 0.2; const ang = Math.random() * Math.PI * 2; const h = Math.random() * 0.5; const shape = (1 - h/0.5); tx = Math.cos(ang) * rad * shape; ty = 3.5 + h; tz = Math.sin(ang) * rad * shape; color = Math.random() > 0.5 ? CONFIG.colors.flameOuter : CONFIG.colors.flameCore; type = 2; size = 2.5; }
            }
            tx *= CAKE_SCALE; ty *= CAKE_SCALE; tz *= CAKE_SCALE; ty += yOffset;
            targets[i3] = tx; targets[i3+1] = ty; targets[i3+2] = tz;
            colors[i3] = color.r; colors[i3+1] = color.g; colors[i3+2] = color.b; sizes[i] = size; types[i] = type;

            const t = Math.random() * Math.PI * 2;
            let hx = 16 * Math.pow(Math.sin(t), 3); let hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
            const scale = 0.65; hx *= scale; hy *= scale;
            const thickness = 0.6; const randR = Math.random() * thickness; const randAng = Math.random() * Math.PI * 2;
            hx += Math.cos(randAng) * randR; hy += Math.sin(randAng) * randR; const hz = Math.sin(randAng) * randR * 2.0;
            heartTargets[i3] = hx; heartTargets[i3+1] = hy; heartTargets[i3+2] = hz;
          }

          const geometry = new THREE.BufferGeometry();
          geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
          geometry.setAttribute('target', new THREE.BufferAttribute(targets, 3));
          geometry.setAttribute('heartTarget', new THREE.BufferAttribute(heartTargets, 3));
          geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
          geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
          geometry.setAttribute('aType', new THREE.BufferAttribute(types, 1));

          const material = new THREE.ShaderMaterial({
            uniforms: {
              uTime: { value: 0 }, uMorph: { value: 0 }, uHeartMorph: { value: 0 }, uFlameState: { value: 0 },
              uPixelRatio: { value: renderer.getPixelRatio() }, uHeartColor: { value: CONFIG.colors.heart }, uHeartGlow: { value: CONFIG.colors.heartGlow }
            },
            vertexShader: `
              uniform float uTime; uniform float uMorph; uniform float uHeartMorph; uniform float uFlameState; uniform float uPixelRatio;
              attribute vec3 target; attribute vec3 heartTarget; attribute float size; attribute vec3 color; attribute float aType;
              varying vec3 vColor; varying float vAlpha;
              void main() {
                vec3 cakePos = mix(position, target, uMorph);
                vec3 currentPos = mix(cakePos, heartTarget, uHeartMorph);
                if (uMorph < 1.0 && uHeartMorph < 0.1) { currentPos.x += sin(uTime + position.y) * 0.2 * (1.0 - uMorph); currentPos.z += cos(uTime + position.x) * 0.2 * (1.0 - uMorph); }
                vColor = color; vAlpha = 1.0;
                if (aType > 1.5 && uHeartMorph < 0.1) { if (uFlameState < 0.1) { vAlpha = 0.0; } else { float flicker = sin(uTime * 20.0 + position.y * 10.0) * 0.05; currentPos.x += flicker; currentPos.z += flicker; vAlpha = 0.8 + 0.2 * sin(uTime * 15.0); } }
                vec4 mvPosition = modelViewMatrix * vec4(currentPos, 1.0);
                gl_Position = projectionMatrix * mvPosition;
                gl_PointSize = size * 1.5 * uPixelRatio * (25.0 / -mvPosition.z);
              }
            `,
            fragmentShader: `
              varying vec3 vColor; varying float vAlpha; uniform vec3 uHeartColor; uniform vec3 uHeartGlow; uniform float uHeartMorph;
              void main() {
                if (vAlpha < 0.01) discard;
                vec2 center = gl_PointCoord - 0.5;
                if (length(center) > 0.5) discard;
                float glow = 1.0 - (length(center) * 2.0); glow = pow(glow, 2.0);
                vec3 mixedColor = mix(vColor, uHeartColor, uHeartMorph);
                if (uHeartMorph > 0.5) { mixedColor = mix(mixedColor, uHeartGlow, glow * 0.5); }
                gl_FragColor = vec4(mixedColor, vAlpha * glow);
              }
            `,
            transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
          });

          const particles = new THREE.Points(geometry, material);
          particlesRef.current = particles;
          scene.add(particles);

          const clock = new THREE.Clock();
          let rAF = 0;
          const animate = () => {
            const time = clock.getElapsedTime();
            material.uniforms.uTime.value = time;
            if (material.uniforms.uHeartMorph.value > 0.1) {
              controls.enabled = false; controls.autoRotate = false;
              camera.position.lerp(new THREE.Vector3(0, 0, 14), 0.05); camera.lookAt(0, 0, 0);
              particles.rotation.set(0, 0, 0); particles.scale.set(1, 1, 1);
            } else {
              controls.enabled = true; controls.autoRotate = true; controls.update();
              particles.rotation.set(0,0,0);
              if (material.uniforms.uMorph.value < 0.1) particles.rotation.y = time * 0.05;
            }
            renderer.render(scene, camera);
            rAF = requestAnimationFrame(animate);
          };
          animate();

          return () => { 
            cancelAnimationFrame(rAF); 
            if(rendererRef.current) rendererRef.current.dispose(); 
            if(geometry) geometry.dispose(); 
            if(controlsRef.current) controlsRef.current.dispose(); 
            stopCamera(); 
          };
        }, [stopCamera, CONFIG]);

        const triggerAction = useCallback((action) => {
          if (!particlesRef.current) return;
          const uniforms = particlesRef.current.material.uniforms;
          switch (action) {
            case 'HEART_MODE':
              setFeedback({icon: <Heart size={40} className="text-pink-500 fill-pink-500" />, text: "Love!"});
              gsap.to(uniforms.uMorph, { value: 1, duration: 0.5 });
              gsap.to(uniforms.uHeartMorph, { value: 1, duration: 2.0, ease: "elastic.out(1, 0.5)" });
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              break;
            case 'CAKE_MODE':
              gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.5, ease: "power2.inOut" });
              break;
            case 'SCATTERED':
              setFeedback({icon: <Wind size={40} />, text: "Scattered!"});
              gsap.to(uniforms.uMorph, { value: 0, duration: 1.5, ease: "power2.inOut" });
              gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.0 });
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              setSurpriseActive(false);
              break;
            case 'ASSEMBLED':
              if (uniforms.uMorph.value < 0.9) {
                setFeedback({icon: <Hand size={40} />, text: "Assembled!"});
                gsap.to(uniforms.uMorph, { value: 1, duration: 1.5, ease: "elastic.out(1, 0.8)" });
                gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.0 });
              }
              break;
            case 'LIT':
              setFeedback({icon: <Flame size={40} className="text-orange-500" />, text: "Lit!"});
              gsap.to(uniforms.uFlameState, { value: 1, duration: 0.5 });
              break;
            case 'EXTINGUISH':
              setFeedback({icon: <Wind size={40} className="text-blue-300" />, text: "Extinguished!"});
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              break;
          }
          if(feedback) setTimeout(() => setFeedback(null), 2000);
        }, [feedback]);

        const onHandResults = (results) => {
          const { cakeState: currentCakeState, surpriseActive: currentSurpriseActive } = stateRef.current;

          if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
             setHandVisible(false);
             setDetectedGesture('No Hand');
             return;
          }

          setHandVisible(true);
          const lm = results.multiHandLandmarks[0];

          const getDist = (p1, p2) => Math.hypot(lm[p1].x - lm[p2].x, lm[p1].y - lm[p2].y);
          
          const isFingerFolded = (tip, pip) => getDist(tip, 0) < getDist(pip, 0); 

          const indexFolded = isFingerFolded(8, 6);
          const middleFolded = isFingerFolded(12, 10);
          const ringFolded = isFingerFolded(16, 14);
          const pinkyFolded = isFingerFolded(20, 18);
          const thumbFolded = getDist(4, 17) < 0.15 || getDist(4, 5) < 0.1;

          const isPinch = getDist(4, 8) < CONFIG.thresholds.pinchDist; 
          const isPeace = !indexFolded && !middleFolded && ringFolded && pinkyFolded;
          const foldedCount = [indexFolded, middleFolded, ringFolded, pinkyFolded].filter(Boolean).length;
          const isFist = foldedCount >= 3 && !isPinch;
          const isOpen = foldedCount <= 1 && !isPinch;

          let currentGesture = 'Unknown';
          if (isPeace) currentGesture = 'PEACE';
          else if (isPinch) currentGesture = 'PINCH';
          else if (isFist) currentGesture = 'FIST';
          else if (isOpen) currentGesture = 'OPEN';
          setDetectedGesture(currentGesture);

          const now = Date.now();
          if (now - lastActionTime.current < 800) return;

          if (isPeace && !currentSurpriseActive) {
            setSurpriseActive(true);
            triggerAction('HEART_MODE');
            lastActionTime.current = now;
            return;
          }

          if (currentSurpriseActive) {
             if (isFist || isOpen) {
               setSurpriseActive(false);
               setCakeState('ASSEMBLED');
               triggerAction('CAKE_MODE');
               lastActionTime.current = now;
             }
             return;
          }

          if (currentCakeState === 'SCATTERED' && isFist) {
             setCakeState('ASSEMBLED');
             triggerAction('ASSEMBLED');
             lastActionTime.current = now;
          } else if (currentCakeState === 'ASSEMBLED' && isPinch) {
             setCakeState('LIT');
             triggerAction('LIT');
             lastActionTime.current = now;
          } else if (currentCakeState !== 'SCATTERED' && isOpen) {
             if (getDist(4,8) > 0.1) { 
               setCakeState('SCATTERED');
               triggerAction('SCATTERED');
               lastActionTime.current = now;
             }
          }
        };

        const startCamera = async () => {
          if (cameraActive.current) return;
          stopCamera();
          
          try {
              if (!window.Hands) throw new Error("MediaPipe Hands not loaded");

              const hands = new window.Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
              hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5 });
              hands.onResults(onHandResults);
              handsRef.current = hands;

              const getStream = async (tries) => {
                  try {
                     return await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
                  } catch (err) {
                     if (tries > 0 && (err.name === 'NotReadableError' || err.name === 'TrackStartError')) {
                         console.warn("Camera busy, retrying in 1s...");
                         await new Promise(r => setTimeout(r, 1000));
                         return getStream(tries - 1);
                     }
                     throw err;
                  }
              };

              const stream = await getStream(1);
              streamRef.current = stream;
              
              if (videoRef.current) {
                  videoRef.current.srcObject = stream;
                  
                  await new Promise((resolve) => {
                      if (videoRef.current.readyState >= 1) resolve();
                      else videoRef.current.onloadedmetadata = () => resolve();
                  });
                  await videoRef.current.play();
                  
                  cameraActive.current = true;
                  setCameraAuthorized(true);
                  setCameraError(null);

                  const loop = async () => {
                      if (!cameraActive.current || !videoRef.current || !handsRef.current) return;
                      if(videoRef.current.readyState === 4 && !videoRef.current.paused && !videoRef.current.ended) {
                        try {
                           await handsRef.current.send({ image: videoRef.current });
                        } catch(e) { /* ignore tracking errors */ }
                      }
                      if (cameraActive.current) requestAnimationFrame(loop);
                  };
                  loop();
              }
          } catch (e) {
              console.error(e);
              let msg = "Camera denied";
              if (e.name === 'NotReadableError' || e.name === 'TrackStartError') msg = "Camera in use. Please close other apps.";
              else if (e.name === 'NotAllowedError') msg = "Permission denied";
              setCameraError(msg);
              cameraActive.current = false;
              stopCamera();
          }
        };

        const startMic = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = ctx.createAnalyser();
            ctx.createMediaStreamSource(stream).connect(analyser);
            analyser.fftSize = 256;
            analyserRef.current = analyser; setMicActive(true);
            const checkAudio = () => {
              if (analyserRef.current) {
                const data = new Uint8Array(analyserRef.current.frequencyBinCount);
                analyserRef.current.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
                if ((sum / data.length) > CONFIG.thresholds.audioLevel) {
                   blowTriggerCount.current++;
                   if (blowTriggerCount.current > 10) { 
                      triggerAction('EXTINGUISH'); 
                      blowTriggerCount.current = 0; 
                   }
                } else blowTriggerCount.current = Math.max(0, blowTriggerCount.current - 1);
              }
              audioCheckRaf.current = requestAnimationFrame(checkAudio);
            };
            checkAudio();
          } catch(e) {}
        };

        return (
          <div className="relative w-full h-screen bg-black overflow-hidden select-none">
            <div ref={containerRef} className="absolute inset-0 z-10 cursor-pointer" onClick={() => {
                if(surpriseActive) { setSurpriseActive(false); setCakeState('ASSEMBLED'); triggerAction('CAKE_MODE'); }
                else if(cakeState === 'SCATTERED') triggerAction('ASSEMBLED');
                else if(cakeState === 'ASSEMBLED') triggerAction('LIT');
                else if(cakeState === 'LIT') triggerAction('EXTINGUISH');
            }} />
            <AnimatePresence>
              {surpriseActive && (
                <motion.div initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.8 }} className="absolute inset-0 z-30 flex flex-col items-center justify-center pointer-events-none px-4">
                  <div className="text-center relative max-w-full translate-y-16">
                    <div className="absolute inset-0 bg-pink-500/20 blur-[60px] rounded-full"></div>
                    <motion.div className="text-6xl md:text-8xl font-black mb-2 tracking-wider relative z-10 font-hand pt-8 pb-4 leading-normal" style={{ background: 'linear-gradient(135deg, #FFE6F2 0%, #FF80B0 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', filter: 'drop-shadow(0px 0px 15px rgba(255, 128, 176, 0.8))' }} animate={{ y: [0, -10, 0] }} transition={{ y: { duration: 3, repeat: Infinity, ease: "easeInOut" } }}>Â∞èÂè∂ÂêåÂ≠¶</motion.div>
                    <motion.div className="text-5xl md:text-7xl font-bold text-white relative z-10 font-hand mt-2 py-2 leading-relaxed" style={{ textShadow: '0 4px 10px rgba(255, 20, 147, 0.6)' }} animate={{ scale: [1, 1.05, 1] }} transition={{ duration: 2, repeat: Infinity, ease: "easeInOut" }}>ÁîüÊó•Âø´‰πê</motion.div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
            <div className="absolute top-24 right-6 z-40 flex flex-col items-end gap-2">
              <div className={`relative w-48 aspect-[4/3] rounded-xl overflow-hidden border-2 border-white/20 shadow-2xl bg-black/80 transition-opacity duration-500 ${cameraAuthorized ? 'opacity-100' : 'opacity-90'}`}>
                <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover opacity-60 mirror-x" playsInline muted />
                {!cameraAuthorized && !cameraError && <div className="absolute inset-0 flex flex-col items-center justify-center text-white/50 text-xs"><Camera size={20} /><span>Click Start Camera</span></div>}
                {cameraError && <div className="absolute inset-0 flex flex-col items-center justify-center text-red-400 bg-black/80 text-center p-2"><XCircle size={24} /><span className="text-xs font-bold mt-1">{cameraError}</span></div>}
              </div>
              <div className="bg-black/50 backdrop-blur-md px-3 py-1 rounded-lg border border-white/10 text-xs font-mono text-usagi-orange">
                 GESTURE: <span className="font-bold text-white uppercase">{detectedGesture}</span>
              </div>
            </div>
            <div className="absolute bottom-8 left-8 z-50 w-72 bg-white/10 backdrop-blur-xl p-5 rounded-2xl border border-white/20 text-white shadow-xl">
              <h3 className="font-bold text-usagi-orange mb-4 flex items-center gap-2 text-lg"><Sparkles size={18} fill="currentColor" /> Magic Controls</h3>
              <div className="flex flex-col gap-2 mb-4">
                {!cameraAuthorized && <button onClick={startCamera} className="w-full bg-usagi-main hover:bg-usagi-hover text-usagi-text font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95"><Camera size={18} /> Start Camera</button>}
                {!micActive && <button onClick={startMic} className="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 border border-white/10 transition-colors"><Mic size={18} /> Enable Blow (Mic)</button>}
              </div>
              <div className="space-y-2 text-sm text-white/80 bg-black/20 p-3 rounded-xl">
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úåÔ∏è Peace</span><span className="font-mono text-[10px] bg-pink-500/20 px-1 rounded text-pink-300">SURPRISE!</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úä Fist</span><span className="font-mono text-[10px] bg-white/10 px-1 rounded">ASSEMBLE</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úã Open</span><span className="font-mono text-[10px] bg-white/10 px-1 rounded">SCATTER</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">üëå Pinch</span><span className="font-mono text-[10px] bg-orange-500/20 px-1 rounded text-orange-300">LIGHT FLAME</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">üå¨Ô∏è Blow</span><span className="font-mono text-[10px] bg-blue-500/20 px-1 rounded text-blue-300">EXTINGUISH</span></div>
              </div>
            </div>
            {feedback && <motion.div initial={{ opacity: 0, scale: 0.5, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.8, y: -20 }} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[60] flex flex-col items-center gap-3 pointer-events-none"><div className="p-8 bg-black/70 backdrop-blur-lg rounded-full text-white shadow-2xl border-4 border-white/10">{feedback.icon}</div><span className="text-white font-bold text-2xl text-shadow-lg tracking-wide bg-black/40 px-4 py-1 rounded-lg backdrop-blur">{feedback.text}</span></motion.div>}
          </div>
        );
      };

      // SCENE 5: Outro
      const Scene5Outro = () => {
        const [message, setMessage] = useState("Wishing you happiness every day!");
        const [isEditing, setIsEditing] = useState(false);
        const captureRef = useRef(null);
        const [captured, setCaptured] = useState(false);
        const handleCapture = async () => {
          if (captureRef.current) {
            setCaptured(true);
            try {
              const canvas = await html2canvas(captureRef.current, { backgroundColor: null, scale: 2, useCORS: true });
              const link = document.createElement('a'); link.download = 'usagi-birthday-wish.png'; link.href = canvas.toDataURL('image/png'); link.click();
            } catch (err) {}
            setCaptured(false);
          }
        };
        return (
          <div className="w-full h-full flex flex-col items-center justify-center p-4 z-40 relative">
            <div className="absolute inset-0 pointer-events-none overflow-hidden z-0"><div className="absolute top-20 left-10 text-6xl opacity-60 rotate-12 animate-bounce-slow">ü•ï</div><div className="absolute top-32 right-20 text-5xl opacity-50 -rotate-12 animate-pulse">‚ú®</div></div>
            <div ref={captureRef} className="relative flex flex-col items-center justify-center p-12 rounded-[3rem] w-full max-w-3xl z-10">
              <div className="absolute inset-0 bg-[#F9D59B]/20 backdrop-blur-[2px] rounded-[3rem] border-4 border-white/40 -z-10"></div>
              <div className="w-72 h-72 md:w-96 md:h-96 relative filter drop-shadow-xl"><UsagiCharacter action="hold-board" className="w-full h-full" boardText={message} /></div>
            </div>
            <div className="mt-8 w-full max-w-md bg-white/95 backdrop-blur rounded-3xl p-6 shadow-2xl border-4 border-usagi-main z-50">
              {isEditing ? (
                <div className="flex flex-col gap-4"><textarea value={message} onChange={(e) => setMessage(e.target.value)} className="w-full p-4 border-2 border-usagi-orange rounded-2xl font-hand text-2xl" rows={3} /><button onClick={() => setIsEditing(false)} className="bg-usagi-main text-usagi-text font-bold py-3 rounded-xl hover:bg-usagi-orange">Update Board ‚ú®</button></div>
              ) : (
                <div className="flex justify-between items-center gap-3"><button onClick={() => setIsEditing(true)} className="flex-1 flex items-center justify-center gap-2 bg-usagi-light text-usagi-text py-4 rounded-2xl border-2 border-usagi-main hover:bg-white"><PenTool size={20} /> Edit Wish</button><button onClick={handleCapture} className="flex-1 flex items-center justify-center gap-2 bg-usagi-pink text-white py-4 rounded-2xl shadow-md border-2 border-white"><Download size={20} /> Save Card</button></div>
              )}
            </div>
            {captured && <motion.div initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} className="fixed bottom-24 bg-usagi-text text-white px-8 py-4 rounded-full shadow-2xl z-[60] font-bold text-xl flex items-center gap-2"><span>üì∏</span> Saved!</motion.div>}
          </div>
        );
      };

      // --- APP ROOT ---
      const App = () => {
        const [scene, setScene] = useState('LOGIN');
        const [muted, setMuted] = useState(false);
        const audioRef = useRef(null);
        useEffect(() => { audioRef.current = new Audio(ASSETS.sounds.bgm); audioRef.current.loop = true; audioRef.current.volume = 0.4; }, []);
        const toggleAudio = () => { if(audioRef.current) { audioRef.current.volume = muted ? 0.4 : 0; setMuted(!muted); } };
        const start = () => { audioRef.current?.play().catch(()=>{}); setScene('PHOTO_WALL'); };
        
        const handleLoginSuccess = () => {
           audioRef.current?.play().catch(()=>{}); 
           setScene('INTRO');
        };

        const back = () => { 
          if(scene==='PHOTO_WALL') setScene('INTRO'); 
          if(scene==='WISHES') setScene('PHOTO_WALL'); 
          if(scene==='CAKE') setScene('WISHES'); 
          if(scene==='OUTRO') setScene('WISHES'); 
        };

        return (
          <div className="relative min-h-screen font-sans text-usagi-text overflow-hidden selection:bg-usagi-pink selection:text-white">
            {scene !== 'LOGIN' && <Background />}
            
            <div className="fixed top-4 right-4 z-50"><button onClick={toggleAudio} className="bg-white/80 p-3 rounded-full shadow-md hover:bg-white border border-usagi-main">{muted ? <VolumeX size={24}/> : <Volume2 size={24}/>}</button></div>
            
            <BackButton onClick={back} disabled={scene==='INTRO' || scene==='LOGIN'} />
            
            <AnimatePresence mode="wait">
              {scene === 'LOGIN' && <Scene0Login key="login" onLogin={handleLoginSuccess} />}
              {scene === 'INTRO' && <Scene1Intro key="intro" onStart={start} />}
            </AnimatePresence>
            
            {scene !== 'INTRO' && scene !== 'LOGIN' && <div className={`absolute inset-0 z-0 flex items-center justify-center transition-opacity duration-500 ${scene==='CAKE'?'opacity-20':'opacity-100'}`}><Scene2PhotoWall isActive={scene==='PHOTO_WALL'} onNext={()=>setScene('WISHES')} showButton={scene==='PHOTO_WALL'} isBackgroundMode={scene!=='PHOTO_WALL'} /></div>}
            
            <AnimatePresence>
              {scene === 'WISHES' && <motion.div key="wishes" className="absolute inset-0 z-10" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene3Wishes onGoToCakeInteraction={()=>setScene('CAKE')} onGoToOutro={()=>setScene('OUTRO')} /></motion.div>}
              {scene === 'CAKE' && <motion.div key="cake" className="absolute inset-0 z-20 bg-black/60 backdrop-blur-sm" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene4CakeInteraction /></motion.div>}
              {scene === 'OUTRO' && <motion.div key="outro" className="absolute inset-0 z-20" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene5Outro /></motion.div>}
            </AnimatePresence>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
